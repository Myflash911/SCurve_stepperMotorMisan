// sample code of a Sinusoidal S-curve code for driving a stepper motor
// it runs on a ESP32, Arduino UNO is ok for low speed only as calculations take much longer
// this is just a proof of concept
// by misan, April 2018


const double espTime[] = {0,0.8339606223319053,0.9946382076625534,1.102915144710818,1.187087301995585,1.256985726887124,1.317307868080828,1.370698791711928,1.418808837054632,1.462743256670634,1.503281772696069,1.540996854329344,1.576322314637914,1.609595454999827,1.641084186801404,1.671005164425508,1.699536302697544,1.726825656288495,1.752997867901108,1.778158947543807,1.802399879006118,1.825799384967213,1.848426077328789,1.870340150906883,1.891594732895806,1.912236969354632,1.932308908333848,1.95184822399071,1.970888815099815,1.989461303414408,2.00759345148227,2.025310515162264,2.042635542806899,2.059589630581153,2.076192141472401,2.092460894062744,2.108412325976637,2.124061636005198,2.139422908185944,2.154509220540232,2.169332740707453,2.183904810340888,2.198236019825962,2.212336274633107,2.226214854413378,2.239880465776415,2.253341289550687,2.266605023209554,2.27967891904939,2.292569818624179,2.305284183872161,2.317828125311753,2.330207427634383,2.342427572979778,2.354493762143082,2.366410933932288,2.378183782867831,2.38981677539324,2.401314164745938,2.412680004619967,2.42391816173752,2.435032327433079,2.446026028342547,2.456902636279785,2.46766537737418,2.478317340535173,2.488861485302881,2.499300649137883,2.50963755419804,2.519874813645361,2.530014937521857,2.540060338229548,2.550013335646438,2.559876161907387,2.569650965876065,2.579339817331856,2.588944710893423,2.598467569698725,2.607910248859573,2.617274538707227,2.626562167844158,2.635774806015822,2.644914066815134,2.653981510231324,2.662978645053863,2.67190693114134,2.680767781564383,2.689562564630954,2.698292605801794,2.706959189503118,2.715563560843195,2.724106927238868,2.732590459957745,2.741015295581206,2.749382537393208,2.757693256699295,2.765948494080075,2.77414926058307,2.782296538856524,2.790391284228613,2.798434425735177,2.806426867098918,2.814369487662829,2.822263143280413,2.830108667165079,2.837906870700988,2.845658544217408,2.853364457728596,2.861025361641016,2.868641987429614,2.876215048284824,2.883745239731774,2.891233240223137,2.898679711707013,2.906085300171047,2.913450636164008,2.920776335295964,2.928062998718062,2.935311213582958,2.942521553486817,2.949694578893753,2.956830837543572,2.963930864843601,2.970995184245328,2.978024307606593,2.985018735539985,2.991978957748032,2.998905453345893,3.005798691171968,3.012659130087113,3.019487219262841,3.026283398459094,3.033048098291963,3.03978174049184,3.046484738152402,3.053157495970818,3.059800410479529,3.066413870270005,3.072998256208758,3.079553941645978,3.086081292617061,3.092580668037357,3.099052419890367,3.105496893409685,3.111914427254947,3.118305353681976,3.124669998707404,3.131008682267955,3.13732171837461,3.143609415261857,3.149872075532194,3.15610999629609,3.162323469307559,3.168512781095532,3.174678213091139,3.180820041751135,3.186938538677517,3.193033970733538,3.199106600156233,3.205156684665558,3.211184477570318,3.217190227870932,3.223174180359202,3.229136575715162,3.235077650601133,3.240997637753043,3.246896766069155,3.252775260696249,3.258633343113388,3.264471231213308,3.270289139381524,3.276087278573278,3.281865856388305,3.287625077143592,3.293365141944116,3.299086248751678,3.304788592451873,3.310472364919263,3.3161377550808,3.32178494897759,3.327414129824983,3.333025478071137,3.338619171454006,3.344195385056884,3.349754291362483,3.355296060305648,3.360820859324712,3.36632885341155,3.371820205160353,3.377295074815208,3.382753620316452,3.388195997345893,3.393622359370918,3.399032857687488,3.404427641462107,3.409806857772754,3.415170651648831,3.420519166110141,3.425852542204926,3.431170919047012,3.43647443385206,3.441763221972961,3.447037416934406,3.452297150466636,3.457542552538411,3.462773751389224,3.467990873560752,3.473194043927605,3.47838338572736,3.483559020589921,3.488721068566209,3.493869648156197,3.499004876336353,3.504126868586416,3.50923573891563,3.514331599888362,3.519414562649181,3.52448473694736,3.529542231160885,3.534587152319898,3.539619606129671,3.544639696993061,3.549647528032501,3.554643201111511,3.559626816855761,3.564598474673688,3.569558272776673,3.574506308198803,3.579442676816222,3.584367473366081,3.58928079146508,3.594182723627656,3.599073361283782,3.603952794796403,3.608821113478527,3.613678405609958,3.618524758453708,3.623360258272071,3.628184990342361,3.632999038972383,3.637802487515539,3.642595418385683,3.647377913071667,3.65215005215159,3.656911915306794,3.661663581335582,3.666405128166646,3.671136632872278,3.675858171681307,3.680569819991768,3.685271652383384,3.689963742629748,3.69464616371034,3.699318987822251,3.703982286391761,3.708636130085629,3.713280588822229,3.717915731782454,3.722541627420422,3.727158343473997,3.731765946975091,3.736364504259824,3.740954080978441,3.745534742105114,3.750106551947509,3.754669574156225,3.75922387173404,3.763769507045001,3.768306541823357,3.772835037182325,3.777355053622703,3.781866651041351,3.786369888739483,3.790864825430871,3.795351519249846,3.799830027759214,3.804300407958008,3.808762716289098,3.813217008646704,3.81766334038375,3.822101766319115,3.826532340744743,3.830955117432648,3.835370149641792,3.839777490124866,3.844177191134913,3.848569304431905,3.852953881289167,3.857330972499697,3.861700628382403,3.866062898788224,3.870417833106151,3.874765480269151,3.879105888760007,3.883439106617042,3.887765181439764,3.892084160394431,3.896396090219502,3.900701017231012,3.904998987327876,3.909290045997091,3.913574238318856,3.917851608971633,3.922122202237089,3.926386062005006,3.930643231778085,3.934893754676688,3.939137673443493,3.943375030448093,3.947605867691526,3.951830226810713,3.956048149082851,3.960259675429732,3.964464846421989,3.968663702283297,3.972856282894483,3.977042627797598,3.981222776199917,3.985396766977893,3.989564638681014,3.993726429535656,3.997882177448842,4.002031920011953,4.006175694504393,4.010313537897196,4.014445486856572,4.018571577747411,4.022691846636747,4.026806329297125,4.030915061210006,4.035018077569011,4.039115413283217,4.043207102980354,4.047293181009963,4.051373681446535,4.055448638092552,4.05951808448155,4.063582053881091,4.067640579295711,4.071693693469828,4.0757414288906,4.079783817790759,4.083820892151397,4.087852683704689,4.091879223936644,4.095900544089731,4.099916675165548,4.103927647927401,4.107933492902879,4.111934240386377,4.115929920441581,4.119920562903953,4.123906197383132,4.127886853265342,4.131862559715754,4.135833345680804,4.139799239890512,4.143760270860746,4.147716466895441,4.151667856088835,4.155614466327628,4.159556325293149,4.163493460463477,4.167425899115519,4.171353668327095,4.175276794978983,4.179195305756916,4.183109227153575,4.187018585470571,4.190923406820351,4.194823717128134,4.198719542133793,4.202610907393712,4.206497838282641,4.210380359995488,4.214258497549138,4.21813227578421,4.222001719366817,4.225866852790269,4.229727700376802,4.233584286279259,4.237436634482732,4.241284768806224,4.245128712904274,4.24896849026854,4.252804124229388,4.256635637957459,4.260463054465203,4.264286396608424,4.268105687087742,4.271920948450131,4.275732203090358,4.279539473252434,4.283342781031061,4.287142148373024,4.290937597078629,4.294729148803041,4.29851682505769,4.302300647211584,4.306080636492672,4.309856813989134,4.313629200650713,4.317397817289967,4.321162684583575,4.324923823073562,4.328681253168565,4.332434995145034,4.336185069148473,4.33993149519461,4.343674293170606,4.347413482836207,4.351149083824905,4.354881115645093,4.358609597681173,4.362334549194698,4.366055989325457,4.369773937092569,4.373488411395581,4.377199431015505,4.380907014615897,4.384611180743887,4.388311947831204,4.392009334195231,4.395703358039956,4.399394037457014,4.403081390426649,4.406765434818698,4.410446188393555,4.414123668803116,4.417797893591716,4.421468880197078,4.425136645951232,4.428801208081393,4.432462583710907,4.436120789860114,4.439775843447242,4.443427761289262,4.44707656010277,4.450722256504818,4.454364867013781,4.45800440805017,4.461640895937467,4.465274346902937,4.46890477707844,4.47253220250122,4.476156639114709,4.479778102769297,4.483396609223099,4.487012174142737,4.490624813104086,4.494234541593017,4.497841375006156,4.501445328651596,4.505046417749629,4.508644657433468,4.512240062749949,4.515832648660244,4.519422430040545,4.523009421682741,4.526593638295134,4.530175094503071,4.533753804849638,4.537329783796309,4.540903045723598,4.544473604931697,4.548041475641137,4.551606671993396,4.555169208051534,4.558729097800826,4.562286355149337,4.565840993928581,4.569393027894074,4.572942470725946,4.576489336029549,4.580033637336004,4.583575388102797,4.587114601714346,4.590651291482575,4.594185470647454,4.597717152377558,4.601246349770627,4.6047730758541,4.608297343585642,4.611819165853698,4.615338555477987,4.61885552521006,4.622370087733781,4.625882255665863,4.629392041556359,4.632899457889171,4.63640451708254,4.639907231489524,4.643407613398514,4.646905675033696,4.65040142855552,4.653894886061187,4.657386059585106,4.660874961099358,4.664361602514155,4.6678459956783,4.671328152379623,4.674808084345431,4.678285803242943,4.681761320679755,4.685234648204212,4.688705797305895,4.692174779416021,4.695641605907849,4.699106288097124,4.702568837242452,4.706029264545744,4.709487581152594,4.71294379815269,4.716397926580208,4.7198499774142,4.723299961578989,4.726747889944537,4.730193773326861,4.733637622488363,4.737079448138237,4.740519260932831,4.743957071476018,4.747392890319539,4.750826727963386,4.754258594856146,4.757688501395367,4.761116457927876,4.76454247475017,4.767966562108723,4.771388730200339,4.774808989172499,4.778227349123667,4.781643820103658,4.785058412113919,4.788471135107907,4.79188199899136,4.79529101362265,4.798698188813083,4.802103534327213,4.805507059883149,4.808908775152874,4.812308689762542,4.815706813292757,4.819103155278916,4.822497725211463,4.825890532536215,4.829281586654615,4.832670896924065,4.836058472658157,4.839444323127016,4.842828457557516,4.84621088513362,4.849591614996596,4.852970656245332,4.856348017936585,4.859723709085256,4.863097738664648,4.866470115606738,4.869840848802417,4.873209947101777,4.876577419314341,4.879943274209329,4.883307520515897,4.886670166923406,4.890031222081642,4.89339069460108,4.896748593053113,4.90010492597031,4.90345970184662,4.906812929137633,4.910164616260823,4.913514771595737,4.916863403484273,4.920210520230873,4.923556130102753,4.92690024133014,4.930242862106478,4.933584000588656,4.936923664897217,4.940261863116583,4.943598603295248,4.946933893446026,4.950267741546208,4.953600155537822,4.956931143327798,4.960260712788205,4.963588871756419,4.966915628035337,4.970240989393601,4.973564963565743,4.976887558252425,4.980208781120613,4.983528639803757,4.986847141902008,4.990164294982379,4.993480106578946,4.996794584193037,5.00010773529339,5.003419567316366,5.006730087666106,5.010039303714718,5.01334722280245,5.016653852237862,5.019959199298014,5.023263271228622,5.026566075244228,5.029867618528371,5.033167908233774,5.03646695148248,5.03976475536602,5.043061326945603,5.046356673252244,5.049650801286943,5.052943718020836,5.056235430395357,5.059525945322383,5.062815269684409,5.066103410334675,5.069390374097337,5.072676167767605,5.075960798111893,5.079244271867983,5.082526595745149,5.0858077764243,5.089087820558159,5.092366734771356,5.095644525660605,5.098921199794825,5.102196763715286,5.105471223935754,5.1087445869426,5.112016859194959,5.115288047124867,5.118558157137368,5.121827195610663,5.125095168896245,5.128362083319011,5.131627945177386,5.13489276074349,5.138156536263199,5.14141927795633,5.144680992016725,5.1479416846124,5.151201361885616,5.154460029953079,5.157717694905981,5.160974362810162,5.164230039706205,5.167484731609568,5.170738444510683,5.173991184375093,5.177242957143517,5.180493768732015,5.183743625032068,5.186992531910693,5.190240495210545,5.193487520750029,5.19673361432343,5.199978781700966,5.203223028628933,5.206466360829798,5.209708784002292,5.212950303821525,5.216190925939071,5.219430655983096,5.222669499558402,5.225907462246581,5.229144549606089,5.232380767172339,5.235616120457784,5.23885061495204,5.242084256121954,5.245317049411713,5.24854900024292,5.251780114014692,5.255010396103752,5.258239851864509,5.261468486629159,5.264696305707748,5.267923314388284,5.271149517936817,5.274374921597493,5.27759953059269,5.280823350123055,5.284046385367607,5.287268641483811,5.290490123607669,5.293710836853782,5.29693078631544,5.3001499770647,5.30336841415246,5.306586102608527,5.30980304744172,5.313019253639903,5.316234726170098,5.319449469978529,5.322663489990721,5.325876791111547,5.329089378225316,5.332301256195817,5.335512429866447,5.338722904060208,5.341932683579818,5.345141773207764,5.348350177706382,5.351557901817907,5.354764950264546,5.35797132774854,5.361177038952228,5.364382088538117,5.367586481148934,5.370790221407691,5.373993313917738,5.377195763262865,5.380397574007294,5.383598750695791,5.386799297853695,5.389999219987004,5.393198521582406,5.396397207107347,5.399595281010076,5.402792747719722,5.405989611646338,5.40918587718094,5.412381548695581,5.415576630543391,5.418771127058636,5.42196504255677,5.425158381334483,5.428351147669741,5.43154334582186,5.434734980031538,5.437926054520904,5.441116573493561,5.444306541134649,5.447495961610898,5.450684839070627,5.453873177643843,5.457060981442274,5.460248254559376,5.463435001070436,5.466621225032559,5.469806930484763,5.472992121447966,5.47617680192508,5.479360975901016,5.482544647342746,5.485727820199318,5.488910498401932,5.492092685863943,5.495274386480919,5.498455604130686,5.501636342673329,5.504816605951286,5.507996397789333,5.511175721994636,5.514354582356798,5.517532982647882,5.520710926622451,5.523888418017602,5.527065460552986,5.530242057930857,5.533418213836107,5.53659393193627,5.539769215881599,5.542944069305047,5.546118495822328,5.549292499031956,5.552466082515227,5.555639249836302,5.558812004542212,5.561984350162869,5.565156290211136,5.568327828182815,5.571498967556677,5.574669711794522,5.577840064341158,5.581010028624473,5.584179608055418,5.587348806028049,5.590517625919568,5.593686071090314,5.596854144883817,5.600021850626784,5.603189191629161,5.606356171184124,5.609522792568122,5.612689059040893,5.61585497384545,5.619020540208163,5.622185761338738,5.625350640430224,5.628515180659088,5.631679385185163,5.63484325715172,5.638006799685456,5.641170015896522,5.644332908878546,5.647495481708633,5.65065773744738,5.653819679138938,5.656981309810938,5.660142632474596,5.663303650124678,5.666464365739516,5.66962478228104,5.672784902694775,5.675944729909862,5.679104266839077,5.682263516378817,5.68542248140915,5.688581164793775,5.691739569380097,5.694897697999185,5.69805555346579,5.701213138578387,5.704370456119156,5.707527508853991,5.710684299532525,5.713840830888117,5.71699710563788,5.720153126482673,5.723308896107131,5.726464417179638,5.729619692352356,5.732774724261235,5.735929515526013,5.739084068750199,5.742238386521128,5.745392471409911,5.748546325971471,5.751699952744555,5.754853354251707,5.758006532999302,5.761159491477528,5.764312232160394,5.767464757505751,5.770617069955255,5.773769171934411,5.776921065852552,5.780072754102829,5.783224239062254,5.786375523091658,5.789526608535697,5.792677497722893,5.795828192965576,5.798978696559917,5.802129010785928,5.805279137907451,5.80842908017214,5.81157883981152,5.814728419040902,5.817877820059442,5.821027045050112,5.824176096179714,5.827324975598857,5.830473685441956,5.833622227827246,5.836770604856765,5.83991881861636,5.843066871175646,5.846214764588072,5.849362500890836,5.852510082104922,5.855657510235111,5.858804787269936,5.861951915181693,5.865098895926441,5.868245731443982,5.87139242365787,5.874538974475388,5.877685385787548,5.88083165946907,5.883977797378417,5.887123801357728,5.89026967323285,5.893415414813313,5.896561027892323,5.899706514246775,5.902851875637189,5.905997113807761,5.909142230486314,5.912287227384303,5.915432106196802,5.918576868602509,5.921721516263697,5.924866050826245,5.92801047391958,5.931154787156721,5.934298992134234,5.937443090432206,5.94058708361429,5.943730973227608,5.946874760802822,5.950018447854067,5.953162035878962,5.956305526358589,5.959448920757477,5.962592220523607,5.965735427088355,5.968878541866541,5.972021566256356,5.975164501639382,5.978307349380564,5.981450110828207,5.984592787313937,5.987735380152718,5.990877890642813,5.994020320065778,5.99716266968644,6.000304940752892,6.003447134496477,6.00658925213174,6.009731294856471,6.012873263851626,6.016015160281357,6.019156985292956,6.022298740016895,6.025440425566743,6.028582043039191,6.031723593514012,6.034865078054068,6.038006497705272,6.041147853496574,6.044289146439948,6.047430377530368,6.050571547745798,6.053712658047162,6.056853709378328,6.059994702666109,6.063135638820219,6.06627651873326,6.069417343280696,6.072558113320873,6.075698829694951,6.078839493226909,6.081980104723504,6.08512066497429,6.088261174751569,6.091401634810373,6.094542045888455,6.097682408706262,6.100822723966902,6.103962992356169,6.107103214542454,6.110243391176779,6.113383522892764,6.11652361030659,6.119663654017001,6.122803654605248,6.125943612635123,6.129083528652884,6.132223403187254,6.135363236749424,6.13850302983299,6.141642782913957,6.144782496450708,6.147922170883998,6.15106180663691,6.15420140411484,6.157340963705503,6.160480485778852,6.163619970687129,6.166759418764782,6.169898830328467,6.173038205677051,6.176177545091535,6.179316848835084,6.182456117152973,6.185595350272576,6.188734548403353,6.191873711736797,6.195012840446461,6.198151934687887,6.201290994598615,6.204430020298147,6.20756901188793,6.21070796945132,6.213846893053593,6.216985782741897,6.22012463854522,6.22326346047439,6.22640224852204,6.229541002662611,6.232679722852281,6.235818409029003,6.238957061112409,6.24209567900387,6.245234262586409,6.248372811724709,6.251511326265097,6.254649806035491,6.257788250845413,6.260926660485939,6.264065034729699,6.267203373330832,6.270341676024991,6.273479942529303,6.276618172542349,6.279756365744141,6.28289452179612};

// using CNCshield
#define STEPX T5
#define DIRX  15
#define ENABLE T2
#define STEPY T4
#define DIRY  16
#define STEPZ T6
#define DIRZ  17
#define SERVO T7
#define STEPS_MM 

double accel=80e3;
double speed=10e3;

int MAX=1000;
const float PI2=PI*PI;
float at=PI*PI/MAX; // 9.867

// linear interpolation function
float solve(float t) { // will return the interpolated time (0..2*PI) that corresponds to a given distance (0 .. PI^2) according to espTime table
 if(t>=PI2) return espTime[MAX-1]; 
 int n=(t/at); 
 float dt=t-n*at;
 if(dt==0) return espTime[n];
 return (espTime[n+1]-espTime[n])*dt/at+espTime[n];
}

void setup() {
  pinMode(ENABLE, OUTPUT); // enable
  pinMode(STEPY, OUTPUT); // stepY
  pinMode(DIRY, OUTPUT); // dirY
  digitalWrite(ENABLE, LOW);
  Serial.begin(115200);
}

int i=0;
int M=5000;  // number of steps at cruising speed
int N=2000;  // number of accel/decel steps
float kt=0.01*10e6; //time adjust constant, accel time = 2*PI*kt = 0.628 seconds
float d=0; // distance traveled 
float t=0; // time elapsed
float last; // keep delay value for cruising speed

float tt;
void loop() {
  
  Serial.println("Accel");
  for(int i=1; i<N; i++) {
    d=PI2*i/N; 
    tt=solve(d)*kt;
    last=tt-t;
    //Serial.println(tt-t); 
    delayMicroseconds(last); // delay is the time difference between values
    digitalWrite(STEPY, HIGH);
    delayMicroseconds(2);
    digitalWrite(STEPY, LOW);
    t=tt;  
  } 
  Serial.println("Cruise");
  for(int i=0; i<M; i++) {
    delayMicroseconds(last); // delay is the time difference between values
    digitalWrite(STEPY, HIGH);
    delayMicroseconds(2);
    digitalWrite(STEPY, LOW);
  }
  Serial.println("Decel");
  for(int i=N-1; i>0; i--) {
    d=PI2*i/N; 
    tt=solve(d)*kt;
    delayMicroseconds(t-tt); // delay is the time difference between values
    digitalWrite(STEPY, HIGH);
    delayMicroseconds(2);
    digitalWrite(STEPY, LOW);
    t=tt;  
  }
  t=0;delay(2000);

}
